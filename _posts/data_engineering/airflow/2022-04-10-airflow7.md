---
title: "[Apache Airflow] Airflow Architecture"
layout: single
date: '10/04/2022'
toc: true
toc_sticky: true
toc_label: Table of Contents
categories:
  - AIRFLOW
tags:
  - AIRFLOW
  - DOCKER
---

---
### Airflow Architecture
* Architecture
* Executors

---

### Architecture
* Scehduler: Triggers schedule workflows and submits tasks for executor to run
* Executor: Defines how to run tasks depending on the system
* Worker: Runs the actual tasks
* Metadata database: Stores information about DAGs and tasks states
* Webserver: User interface to insepct, trigger and debug DAGs and tasks behavior
* Dags folder: Directory where all DAGs code is persisted, read by scheduler & executor

#### Architecture
<p align="center">
    <img src="/img/data_engineering/airflow/airflow1.png" align="center">
</p>

#### Executor-Task
<p align="center">
    <img src="/img/data_engineering/airflow/airflow2.png" align="center">
</p>

    

---

### Executors
#### LocalExecutor
<p align="center">
    <img src="/img/data_engineering/airflow/airflow3.png" align="center">
</p>

* LocalExecutorì˜ ê²½ìš° ë‹¨ì¼ ë…¸ë“œì˜ Scheudlerì— ì˜ì¡´í•˜ê¸°ì— Productionì— ì í•©í•˜ì§€ ì•ŠìŒ

#### CeleryExecutor
<p align="center">
    <img src="/img/data_engineering/airflow/airflow4.png" align="center">
</p>

* CeleryExecutorì˜ ê²½ìš°, Workerê°€ í•­ìƒ ì¼í•˜ê¸°ì— ìš´ì˜í•˜ëŠ” Dagê°€ ë§ì„ ê²½ìš° ë” ì í•©í•  ìˆ˜ ìˆìŒ
* Celery QueueëŠ” Result Backendì™€ Brokerë¡œ ì´ë£¨ì–´ì§
  * Result Backend: workerê°€ exectueí•œ taskì˜ statusë¥¼ ì €ì¥
  * Broker: schedulerê°€ ìˆ˜í–‰í•´ì•¼ë  taskë¥¼ ë³´ë‚´ëŠ” queueì´ì, workerê°€ ìˆ˜í–‰í•´ì•¼ë  taskë¥¼ pullí•´ì˜¤ëŠ” queue
    * ê°€ë ¹ í•œ Dagê°€ `T1 >> [T2, T3] >> T4` ë¡œ ë˜ì–´ìˆëŠ” ê²½ìš°ê°€ ì¡´ì¬
      * 1) SchedulerëŠ” T1ì„ Brokerì—ê²Œ ë³´ëƒ„
      * 2) Worker1ì´ Brokerì—ì„œ T1ì„ ë°›ì•„ì˜¨ ë’¤ ìˆ˜í–‰ ì™„ë£Œ í›„ Result Backendì— ê²°ê³¼ ì™„ë£Œì—¬ë¶€ë¥¼ ë³´ëƒ„
      * 3) SchedulerëŠ” T2, T3ë¥¼ Brokerì—ê²Œ ë³´ëƒ„
      * 4) Worker2ì´ T2ë¥¼, Worker3ê°€ T3ë¥¼ ë°›ì•„ì˜¨ ë’¤ ê°ê° ìˆ˜í–‰ì„ ì™„ë£Œí•œ í›„ Result Backendì— ê²°ê³¼ ì™„ë£Œì—¬ë¶€ë¥¼ ë³´ëƒ„
      * 5) SchedulerëŠ” T4ë¥¼ Brokerì—ê²Œ ë³´ëƒ„
      * 6) Worker1ì´ Brokerì—ì„œ T4ì„ ë°›ì•„ì˜¨ ë’¤ ìˆ˜í–‰ ì™„ë£Œ í›„ Result Backendì— ê²°ê³¼ ì™„ë£Œì—¬ë¶€ë¥¼ ë³´ëƒ„
    * íŠ¹ì • Workerì—ì„œ íŠ¹ì • Taskê°€ ë³´ë‚´ì§€ë„ë¡ Workerë§ˆë‹¤ Queueë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŒ
      * ì´ ê²½ìš° ì—¬ëŸ¬ ê°œì˜ Queueê°€ ì¡´ì¬í•˜ê²Œ ë¨
      * Workerë§ˆë‹¤ ì‚¬ì–‘(CPU/ GPU)ì´ ë‹¤ë¥¼ ìˆ˜ ìˆê¸° ë–„ë¬¸ì— ìœ ìš©
* cfg ì„¤ì • ì‚¬í•­
  * 1) `executor=CeleryExecutor`
  * 2) `sql_alchemy_conn=postgresql+psycopg2://[user]:[pw]]@[host]/[db]`
  * 3) `celery_result_backend=postgresql+psycopg2://[user]:[pw]]@[host]/[db]`
    * ë°˜ë“œì‹œ airflowì˜ metadataë¥¼ storeí•˜ëŠ” dbë‘ ê°™ì€ dbë¥¼ ì¨ì•¼ë˜ëŠ” ê²ƒì€ ì•„ë‹˜
  * 4) `celery_broker_url=redis://:@redis:6379/0`
    * ìœ„ëŠ” redisë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì˜ ì˜ˆì‹œ, RabbitMQë„ ê°€ëŠ¥
* Workerê°€ ë  ì»´í“¨í„°ì—ì„œ `celery worker`ë¼ê³  ì…ë ¥í•˜ë©´ ë¨
  * ë§Œì•½ í•´ë‹¹ Workerì—ë§Œ ë³´ë‚´ê³  ì‹¶ì€ Taskê°€ ìˆëŠ” ê²½ìš° `celery worker -q [queue_name]` ì…ë ¥
    * (e.g. `celery worker -q high_cpu`)
    * [ğŸ”— íŠ¹ì • taskë¥¼ íŠ¹ì • queueë¥¼ ë³´ë‚´ê³  ì‹¶ì€ ê²½ìš°](https://zsu58.github.io/airflow/airflow13/)
    * cf. ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  taskëŠ” default queueë¡œ ê°

#### KubernetesExecutor
<p align="center">
    <img src="/img/data_engineering/airflow/airflow5.png" align="center">
</p>

* ìœ„ì™€ ê°™ì€ ê²½ìš°ê°€ ì•„ë‹ˆë¼ë©´ Kubernetesë¥¼ í™œìš©í•  ë–„ ë” íš¨ìœ¨ì ìœ¼ë¡œ(cost-effective) pipeline ìš´ì˜ ê°€ëŠ¥

---

### ref 
* [ğŸ”— ì°¸ê³ ](https://www.youtube.com/watch?v=TQIInLmKM4k)
