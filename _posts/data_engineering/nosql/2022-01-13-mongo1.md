---
title: "[NoSQL] MongoDB Shell"
layout: single
date: '13/1/2022'
toc: true
toc_sticky: true
toc_label: Table of Contents
categories:
  - NOSQL
tags:
  - SQL
  - MONGODB
---

---
### MongoDB Shell
* MongoDB Shell Overall
* MongoDB Shell Find
* MongoDB Shell Update & Remove & Drop
* MongoDB Shell Aggregate

---

### MongoDB Shell Overall
```bash
# ì ‘ì†
mongosh -u "root" -p "1234" 

# show all DB
show dbs;

# db ìƒì„± ë° í•´ë‹¹ dbë¡œ ì ‘ì† (use [db_name])
use testDB;

# í˜„ì¬ ì ‘ì†í•´ìˆëŠ” db ì‚­ì œ
db.dropDatabase();

# collection ë§Œë“¤ê¸°
db.createCollection("user");

# user collection(rdbms:table)ì— documents(row) ì¶”ê°€
db.user.insertMany([
  {uName: "Tom", pwd: "1111", age: 20},
  {uName: "Jane", pwd: "2222", age: 30},
]);

# document ì¶”ê°€
db.user.insertOne({uName: "zsu", pwd: "6666"});

# ì „ì²´ documents ë³´ê¸°
db.user.find();

# uNameì´ Tomì¸ row ë³´ê¸°
db.user.find({uName:"Tom"});

# uNameì´ Janeì¸ documentì˜ ë¹„ë°€ë²ˆí˜¸ 4444ë¡œ ë°”ê¾¸ê¸°
db.user.update({uName:"Jane"}, {$set: {pwd:4444}});

# uNameì´ Janeì¸ document ì‚­ì œ
db.user.deleteOne({uName:"Jane"});
```
---

### MongoDB Shell Find
```bash
# collection ë§Œë“¤ê¸°
db.createCollection("score");

# document ì¶”ê°€
db.score.insertMany(
  {name: "Sophia", point:99},
  {name: "Alice", point:85},
  {name: "Jane", point:76},
  {name: "James", point:64},
);

# ë¯¸ë¦¬ listì„ ë§Œë“¤ì–´ë‘ê³  ì¶”ê°€
var names = ["Jane", "Tom", "Alice", "James", "Sophia"];
var points = [76,54,85,64,99];
for (i=0; i<names.length; i++){
  db.score.insertOne({name:names[i], point:points[i]});
  };

# pointê°€ 90ì  ì´ˆê³¼ì¸ ë°ì´í„° ì°¾ê¸°
db.score.find({point:{$gt:90}});

# pointê°€ 70ì  ì´ˆê³¼ì¸ ì²« ë²ˆì§¸ ë°ì´í„° ì°¾ê¸°
db.score.findOne({point:{$gt:70}});

# pointê°€ 60ì  ì´ìƒ 90ì¡ˆ ì´í•˜ì¸ ë°ì´í„° ì°¾ê¸°
db.score.find({point:{$gte:60, $lte:90}});
# ìœ„ì™€ ê°™ìŒ
db.score.find({point:{$gte:60}, point:{$lte:90}});

# pointê°€ 54, 76, 99ì  ì¤‘ ìˆëŠ” ë°ì´í„° ì°¾ê¸°
db.score.find({point:{$in:[54,76,99]}});

# pointê°€ 54, 76, 99ì  ì™¸ì˜ ë°ì´í„° ì°¾ê¸°
db.score.find({point:{$nin:[54,76,99]}});

# pointê°€ 60 ì´í•˜ or 90 ì´ìƒì¸ ë°ì´í„°ë§Œ ì°¾ê¸°
db.score.find(
  {
    $or:[
      {point:{$lte:60}},{point:{$gte:90}}
      ]
  }
);

# point columnì´ ìˆëŠ” document ì°¾ê¸°
db.score.find({point:{$exists:true}});

# point columnì´ ì—†ëŠ” document ì°¾ê¸°
db.score.find({age:{$exists:false}});

# db.collection.find({condition},{column:0/1}), 0=don't show, 1=show
# pointê°€ 76ì  ì´ìƒì¸ documentì˜ ì´ë¦„ë§Œ ì°¾ê¸°
db.score.find({point:{$gte:76}},{_id:0, name:1});

# limit query result to 2
db.score.find().limit(2);

# skip two document
db.score.find().skip(2);

# sort by point(ascending)
db.score.find().sort({point:1});

# sort by point(descending)
db.score.find().sort({point:-1});

# document ì¤‘ nameì´ Janeì´ë©´ì„œ certi columnì´ ìˆëŠ” document ì œê±°
db.score.deleteOne({name:"Jane", certi:{$exists:true}});
```
---

### MongoDB Shell Update & Remove & Drop
```bash
db.test.insertMany(
  [
    {name:"Jane", certi:["Java", "OS", "Excel"]},
    {name:"Tom", certi:["DB", "Secuity"]},
    {title:"IT Trend", author:"James", price:5000},
    {name:"Alice", certi:["PPT", "SQL", "Web"]},
    {name:"John", age:34}
  ]
);

# nameì´ Johnì¸ documentì˜ age column ì‚­ì œ
db.score.update({name:"John"},{$unset:{age:34}});

# titleì´ IT Trendì¸ documentì—ì„œ price: 35000ì´ë¼ëŠ” column ì¶”ê°€
db.score.update({title:"IT Trend"},{$set:{price:35000}});

# titleì´ IT Trendì¸ documentì—ì„œ price: 35000ì—ì„œ 70000ìœ¼ë¡œ ë³€ê²½
db.score.update({title:"IT Trend"},{$set:{price:70000}});

# nameì´ Johnì¸ documentì—ì„œ cert:["OS", "DB"]ì´ë¼ëŠ” column ì¶”ê°€
db.score.update({name:"John"},{$set:{certi:["OS", "DB"]}});

# nameì´ Johnì¸ documentì—ì„œ cert columnì— Word ì¶”ê°€
db.score.update({name:"John"},{$push:{certi:"Word"}});

# nameì´ Johnì¸ documentì—ì„œ cert columnì— Word ì œê±°
db.score.update({name:"John"},{$pull:{certi:"Word"}});

# nameì´ Janeì¸ document ì œê±°
db.score.remove({name:"Jane"});

# collectionì˜ documents ì‚­ì œ
db.score.remove({});

# collection ì‚­ì œ
db.score.drop();
```
---

### MongoDB Shell Aggregate
```bash
# select deptno, and dname
db.dept.aggregate([
  {"$project": {"_id": 0, "deptno": 1, "dname": 1}}
]);

# select deptno, and dname, and limit the data to 3
db.dept.aggregate([
  {"$project": {"_id": 0, "deptno": 1, "dname": 1}}, {"$limit": 2}
]);

# count all documents in dept collection
db.dept.aggregate([
  {"$group": {"_id": 0, "count": {"$sum":1}}}
])

# count employees by deptno
db.emp.aggregate([
  {"$group": {"_id": "$deptno", "count": {"$sum": 1}}}
])

# sum of salary by deptno
db.emp.aggregate([
  {"$group": {"_id": "$deptno", "count": {"$sum": "$sal"}}}
])

# mean of salary by job
db.emp.aggregate([
  {"$group": {"_id": "$job", "count": {"$avg": "$sal"}}}
])

# round mean of salary by job
db.emp.aggregate([
  {"$group": {"_id": "$job", "avg":{"$avg": "$sal"}}}, 
  {"$addFields": {"avg": {"$round":["$avg", -1]}}} 
])

# dept collectionì„ ê¸°ì¤€ìœ¼ë¡œ emp collection join í•œ ë’¤ dept_emp_joinì´ë¼ëŠ” collectionì— ì €ì¥
# from - joinë  collection name (emp)
# localField - dept collectionì˜ ê¸°ì¤€ field
# foreignField - emp collectionì˜ ê¸°ì¤€ field
# as - ê¸°ì¤€ collection(dept)ì— ìƒˆë¡œìš´ filedê°€ ë§Œë“¤ì–´ì§€ë©° í•´ë‹¹ filed ì•„ë˜ì— ê¸°ì¤€ì— ë§ëŠ” emp collectionì˜ objectì´ ë“¤ì–´ê°
db.dept.aggregate([
  {
    "$lookup":
      {
        "from": "emp", 
        "localField": "deptno", 
        "foreignField": "deptno", 
        "as": "dno"
      }
  },
  {"$out": "dept_emp_join"}
])

# dname ê°œìˆ˜
db.dept_emp_join.aggregate(
  {"$unwind": "$dno"},
  {"$group": {"_id": 0, "count":{"$sum":1}}}
)

# dnameë³„ ì¸ì› ìˆ˜
db.dept_emp_join.aggregate(
  {"$unwind": "$dno"},
  {"$group": {"_id": "$dname", "count":{"$sum":1}}}
)

# dname ë³„ ê¸‰ì—¬ í•©ê³„
db.dept_emp_join.aggregate(
  {"$unwind": "$dno"},
  {"$group": {"_id": "$dname", "sum":{"$sum": "$dno.sal"}}}
)

# Accounting ë¶€ì„œ ì†Œì† ì§ì›ë“¤ì˜ ì‚¬ë²ˆ, ì´ë¦„, ê¸‰ì—¬ëŠ”? ê¸‰ì—¬ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ascendingí•˜ê²Œ sort, (descendingì¼ ê²½ìš° -1)
db.dept_emp_join.aggregate(
  {"$match": {"dname": "ACCOUNTING"}},
  {"$unwind": "$dno"},
  {"$project": {"dno.empno": 1, "dno.ename": 1, "dno.sal": 1}},
  {"$sort": {"dno.sal": 1}}
)
```
---

### ref
* [ğŸ”— MongoDB Shell Command ê³µì‹ë¬¸ì„œ](https://docs.mongodb.com/manual/reference/mongo-shell/#command-helpers)